<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Page Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <link rel="stylesheet" type="text/css" media="screen" href="main.css" /> -->
    <!-- <script src="main.js"></script> -->
</head>
<style>

    body {
        width: 100%;
        height: 100%;
        overflow: hidden;

        /* 隐藏鼠标 */
        /* cursor: none; */ 
    }

    * {
        padding: 0;
        margin: 0;
    }

    #wrap {
        z-index: 9;
    }

    .movie {
        display: inline-block;
        width: 240px;
        height: 135px;
        overflow: hidden;
        margin: 5px 15px;
        position: relative;
    }

    .movie .progress-bar {
        position: absolute;
        width: 220px;
        height: 5px;
        background-color: rgba(0, 0, 0, .6);
        top: 5px;
        left: 10px;
        border-radius: 5px;
        visibility: hidden;
        overflow: hidden;
    }

    .movie .mask {
        position: absolute;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        opacity: 0;
        background-color: rgba(0, 0, 0, .2);
        transition: opacity .1s linear;
        z-index: 1;
    }

    .movie:hover {
        /* cursor: pointer; */
    }

    .movie:hover .mask {
        opacity: 1;
        cursor: pointer;
    }

    .movie:hover .progress-bar {
        visibility: visible;
    }

    .movie .progress-bar span {
        display: block;
        width: 0;
        height: 100%;
        background-color: #ffffff;
        z-index: 9;
    }

    .movie img {
        width: 720px;
        height: 408px;
        /* overflow: hidden; */
    }

    /* 视频  */

    #movie-wrap {
        width: 750px;
        height: 450px;
        margin: 0 auto;
        position: relative;
    }

    #movie-wrap .movie {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
    }

    #movie-wrap.full {
        position: fixed;
        width: 100%;
        height: 100%;
        min-height: 100vh;
        left: 0;
        top: 0;
        z-index: 99;
    }

    #movie-wrap .controls {
        display: flex;
        position: absolute;
        width: 100%;
        height: 40px;
        line-height: 40px;
        background-color: rgba(0, 0, 0, .3);
        bottom: 0;
        left: 0;
        color: #ffffff;
        padding: 0 10px;
        box-sizing: border-box;
        /* visibility: hidden; */
        visibility: visible;

        /* transition: all .6s ease-out; */
        /* opacity: 0; */
    }

    #movie-wrap:hover {
        cursor: pointer;
    }

    #movie-wrap:hover #controls {
        /* opacity: 1; */
        visibility: visible;
    }

    #movie-wrap .controls .play {}

    #movie-wrap .controls .process-bar {
        width: 100%;
        background-color: rgba(255, 255, 255, .6);
        position: relative;
    }

    #movie-wrap .controls .process-bar span {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        display: block;
        width: 0;
        height: 100%;
    }

    #movie-wrap .controls .process-bar .play {
        background-color: rgba(0, 0, 0, .6);
    }

    #movie-wrap .controls .process-bar .pre {
        background-color: rgba(0, 0, 0, .3);
    }

    #movie-wrap .controls .volume {}

    #movie-wrap .controls .full {}
</style>

<body>
    <!-- <div class="movie">
        <img src="https://puui.qpic.cn/video_caps/0/s0741d97h7o.q4.jpg/0">
    </div> -->
    <div id="wrap"></div>

    <div id="movie-wrap">
        <video id="movie" class="movie" preload="auto">
            <source src="http://wxsnsdy.tc.qq.com/105/20210/snsdyvideodownload?filekey=30280201010421301f0201690402534804102ca905ce620b1241b726bc41dcff44e00204012882540400&bizid=1023&hy=SH&fileparam=302c020101042530230204136ffd93020457e3c4ff02024ef202031e8d7f02030f42400204045a320a0201000400"
                type="video/mp4"> Your browser does not support the video tag.
        </video>

        <div id="controls" class="controls">
            <span id="play" class="play" data-control="play">play</span>
            <div id="process-bar" class="process-bar">
                <span class="play"></span>
                <span class="pre"></span>
            </div>

            <div id="volume" class="volume" data-control="volume">
                <span></span>
            </div>

            <span id="full" class="full" data-control="full">full</span>
        </div>
    </div>
</body>

<!-- movie-wrap -->
<script>
    var movieWrap = document.getElementById("movie-wrap");
    const clientWidth = window.screen.availWidth;
    const clientHeight = window.screen.availHeight ;

    var movie = document.getElementById("movie");//视频
    var play = document.getElementById("play");//播放
    var process = document.getElementById("process-bar");//进度div
    var processBar = process.getElementsByTagName("span")[0];;//进度条
    var preBar = process.getElementsByTagName("span")[1];;//选择进度
    var volume = document.getElementById("volume");//音量
    var full = document.getElementById("full");//全屏、退出全屏

    var videoDuration;

    var processHeight = parseInt(window.getComputedStyle(process).width);//获取进度条宽度

    play.addEventListener('click', handleControls);
    full.addEventListener('click', handleControls);

    process.addEventListener('mousemove', event => {
        Throttle(handleProcess.bind(this, event))
    });

    process.addEventListener('click', event => {
        Throttle(handleProcess.bind(this, event))
    });

    movie.addEventListener('timeupdate',function(event){
        // console.log(123,event);
        // console.log(111,processHeight);

        const { currentTime ,duration} = event.target;
        processBar.style.width = `${((currentTime/duration).toFixed(2))*100}%`;
        videoDuration = duration;
        
    })

    function handleProcess(event){
        console.log('offsetX',event.offsetX);
        switch (event.type) {
            case 'click':
                movie.currentTime = ((event.offsetX / processHeight).toFixed(2)) * videoDuration;
                break;
            case 'mousemove':
                preBar.style.width = `${((event.offsetX / processHeight).toFixed(2)) * 100}%`;
                break;
            default:
                break;
        }
    }

    function handleControls(event) {
        const { control } = event.target.dataset;
        switch (control) {
            case "play":
                movie.play();
                play.setAttribute('data-control', 'pause');
                play.innerText = "pause";
                break;
            case "pause":
                movie.pause();
                play.setAttribute('data-control', 'play');
                play.innerText = "play";
                break;
            case "full":
                fullScreen(true, function () {
                    full.setAttribute('data-control', 'exitFull');
                    full.innerText = "exitFull";
                    movieWrap.className = "full"
                });
                break;
            case "exitFull":
                fullScreen(false, function () {
                    full.setAttribute('data-control', 'full');
                    full.innerText = "full";
                    movieWrap.className = ""
                });
                break;
            default:
                break;
        }
    }

    function fullScreen(fullStatus=true, callback) {
        var docElm = document.documentElement;

        function full() {
            //W3C
            if (docElm.requestFullscreen) {
                docElm.requestFullscreen();
            }
            //FireFox
            else if (docElm.mozRequestFullScreen) {
                docElm.mozRequestFullScreen();
            }
            //Chrome等
            else if (docElm.webkitRequestFullScreen) {
                docElm.webkitRequestFullScreen();
            }
            //IE11
            else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }

        function exitFull() {
            //退出全屏
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }

            else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            }

            else if (document.webkitCancelFullScreen) {
                document.webkitCancelFullScreen();
            }

            else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
        }

        //监听是否全屏
        // document.addEventListener("fullscreenchange", function () {

        //     fullscreenState.innerHTML = (document.fullscreen) ? "" : "not ";
        // }, false);

        // document.addEventListener("mozfullscreenchange", function () {

        //     fullscreenState.innerHTML = (document.mozFullScreen) ? "" : "not ";
        // }, false);

        // document.addEventListener("webkitfullscreenchange", function () {

        //     fullscreenState.innerHTML = (document.webkitIsFullScreen) ? "" : "not ";
        // }, false);

        // document.addEventListener("msfullscreenchange", function () {

        //     fullscreenState.innerHTML = (document.msFullscreenElement) ? "" : "not ";
        // }, false);

        if(fullStatus) {
            full();
        }else{
            exitFull();
        }

        console.log("fullStatus",fullStatus);
        if ("function" === typeof callback) callback();
    }

</script>

<script>
    const D_TIME = 1000 / 60;

    function Throttle(fn, t = D_TIME) {
        if (fn.timer) clearTimeout(fn.timer);
        fn.timer = setTimeout(fn, t)
    }
</script>

<script>
    function init() {
        var wrap = document.getElementById("wrap");
        var childDom;


        for (let i = 0; i < 3; i++) {
            var node = document.createElement("div");
            node.className = "movie";
            // node.dataset.index = i;

            //mask
            var mask = document.createElement("div");
            mask.dataset.index = i;
            mask.className = "mask"

            //进度div sNode
            var sNode = document.createElement("div");
            sNode.className = "progress-bar";

            //进度条 process
            var process = document.createElement("span");
            sNode.appendChild(process);

            //图片
            var img = document.createElement("img");
            img.src = Math.random() > 0.5 ? "https://puui.qpic.cn/video_caps/0/s0741d97h7o.q4.jpg/0" : "https://puui.qpic.cn/video_caps/0/s0741qfdf12.q4.jpg/0";
            img.className = "img";
            img.dataset.index = i;

            node.appendChild(img);
            node.appendChild(sNode);
            node.appendChild(mask);

            wrap.appendChild(node)
        }

    }

    (function () {
        init();
    })()


    function handleEventListener(event) {
        // console.log(event);
        // console.log('layerX',event.layerX);
        // console.log('movementX',event.movementX);

        var { index } = event.target.dataset;
        if (!index) return;
        switch (event.type) {
            case "mousemove":
                var getCoordinate = function (pageX) {
                    const imgRow = 3, totalImg = 8;
                    var pos = Math.ceil(pageX / (240 / totalImg));
                    var x, y, z = Math.floor(pos / imgRow);

                    x = ((pos - (z * imgRow)) - 1) * 240; //pos是从1开始，而z是从0开始所以要减1
                    y = z * 135;
                    return { x, y }
                }

                var wrapEl = document.getElementById("wrap");//wrap element
                var m = wrapEl.getElementsByClassName("img")[index];
                /**
                * @desc 图片转换
                */
                var cor = getCoordinate(event.layerX);
                m.style.transform = `translate(-${cor.x}px,-${cor.y}px)`;

                /**
                * @desc 进度条
                */
                var pEl = wrapEl.getElementsByClassName("progress-bar")[index]; //process element
                pEl.getElementsByTagName("span")[0].style.width = `${((event.layerX / 240) * 100).toFixed(2)}%`;//process-bar
                break;
            case "mouseout":
                var wrapEl = document.getElementById("wrap");//wrap element
                var m = wrapEl.getElementsByClassName("img")[index];

                var pEl = wrapEl.getElementsByClassName("progress-bar")[index]; //process element
                pEl.getElementsByTagName("span")[0].style.width = '0';//process-bar
                // pEl.style.visibility = "hidden";

                m.style.transform = `translate(0,0)`;
                break;

            case "mouseover":
                var wrapEl = document.getElementById("wrap");//wrap element
                var pEl = wrapEl.getElementsByClassName("progress-bar")[index]; //process element
                // pEl.style.visibility = "visible";

                break;

            default:
                break;
        }
    }

    document.onreadystatechange = function () {
        // console.log(223, document.readyState);
        switch (document.readyState) {
            case "interactive":
                break;

            case "complete":
                // var d = document.getElementsByClassName("movie");
                var d = document.getElementById("wrap");
                // d.addEventListener('mousemove', Throttle(handleEventListener.bind(this,event)));

                d.addEventListener('mousemove', event => {
                    Throttle(handleEventListener.bind(this, event))
                });//移动(函数防抖)

                d.addEventListener('mouseout', handleEventListener);//移出
                d.addEventListener('mouseover', handleEventListener);//移入
                break;

            default:
                return;
        }
    }
</script>

</html>